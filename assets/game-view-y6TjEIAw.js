import{b as p,y as a,f as w,_ as N,S as z,t as T,$ as D,d as M,g as E,h as F,E as W,i as R}from"./vendor-r3QpqBWY.js";import{G as P,g as S,a as C,b as c,c as o,d as m,A as k}from"./index-wxipzR0L.js";import{f as B,s as $,H as X,a as U,g as Y}from"./highscores-table-4-M-UVGM.js";import{I as f}from"./icon-name.enum-0ePiKs41.js";const G=Object.entries(P).reduce((n,[t,i])=>({...n,[i]:t}),{});function H(n){return G[n]}class j extends p{render({highscore:t,difficulty:i}){return a("div",{class:"c-congratulations"},a("div",{class:"c-congratulations__title"},a("img",{class:"e-icon",src:`icons/${f.Party}.png`})," Congratulations!"),t?a("div",{class:"c-congratulations__text"},"You won in ",a("strong",null,B(t.time))," claiming rank ",a("strong",null,t.rank)," ","in highscores for difficulty ",a("em",null,H(i)),"."):"")}}class L extends p{render(){const{flagsCount:t,minesCount:i}=w(S);return a("div",{class:"c-flags",title:"Flags / Mines"},a("div",{class:"c-flags__label"},t,"/",i),a("div",{class:"c-flags__icon"},a("img",{class:"e-icon",src:`icons/${f.FlagOnGreen}.png`})))}}function K(n){if(!Array.isArray(n))throw new TypeError(`Expected an array, got ${typeof n}`);n=[...n];for(let t=n.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[n[t],n[i]]=[n[i],n[t]]}return n}var v=(n=>(n[n.Boom=f.Boom]="Boom",n[n.Flag=f.Flag]="Flag",n))(v||{});const A=[{name:v.Boom,src:"icons/boom.png"},{name:v.Flag,src:"icons/flag.png"}];async function V(n){return new Promise((t,i)=>{const e=new Image;e.addEventListener("error",s=>i(s)),e.addEventListener("load",()=>t({...n,image:e})),e.src=n.src})}const q=document.head.baseURI,O={};for(let n=0;n<A.length;n++){const{name:t,src:i}=A[n],e=await V({name:t,src:$(q,i)});O[e.name]=e}function J(n){const t=O[n];if(!t)throw new Error(`PaintAsset with name '${n}' not found`);return t}const Z={width:10,height:10,x:0,y:0,strokeWidth:1,active:!0,interactive:!0};class _{width;height;x;y;fillStyle;strokeStyle;strokeWidth;active;interactive;onClick;children=[];constructor(t){const{width:i,height:e,x:s,y:h,fillStyle:l,strokeStyle:r,strokeWidth:u,active:g,interactive:d}={...Z,...t};this.width=i,this.height=e,this.x=s,this.y=h,this.fillStyle=l,this.strokeStyle=r,this.strokeWidth=u,this.active=!!g,this.interactive=!!d,t.onClick&&(this.onClick=t.onClick)}render(t){if(this.active){if(this.fillStyle||this.strokeStyle){const i=(this.strokeWidth||1)*t.pixelDensity,e=this.x*t.pixelDensity,s=this.y*t.pixelDensity,h=this.width*t.pixelDensity,l=this.height*t.pixelDensity,r=[e,s,h,l];this.fillStyle&&(t.context.fillStyle=this.fillStyle,t.context.fillRect(...r)),this.strokeStyle&&(t.context.strokeStyle=this.strokeStyle,t.context.lineWidth=i,t.context.strokeRect(...r))}for(let i=0;i<this.children.length;i++)this.children[i].render(t,this)}}add(...t){this.children.push(...t)}clear(){this.children=[]}isHitBy(t,i){return t>=this.x&&t<=this.x+this.width&&i>=this.y&&i<=this.y+this.height}}const Q={x:0,y:0,fontSize:24,fontFamily:"sans-serif",textAlign:"center",textBaseline:"middle",direction:"ltr"};class tt{text;x;y;fontSize;fontFamily;textAlign;textBaseline;direction;fillStyle;strokeStyle;strokeWidth;constructor(t){const{text:i,x:e,y:s,fontSize:h,fontFamily:l,textAlign:r,textBaseline:u,direction:g,fillStyle:d,strokeStyle:b,strokeWidth:x}={...Q,...t};this.text=i,this.x=e,this.y=s,this.fontSize=h,this.fontFamily=l,this.textAlign=r,this.textBaseline=u,this.direction=g,this.fillStyle=d,this.strokeStyle=b,this.strokeWidth=x}render(t,i){if(t.context.font=`${this.fontSize*t.pixelDensity}px ${this.fontFamily}`,t.context.textAlign=this.textAlign,t.context.textBaseline=this.textBaseline,t.context.direction=this.direction,this.fillStyle||this.strokeStyle){const e=(this.strokeWidth||1)*t.pixelDensity,s=(i.x+this.x)*t.pixelDensity,h=(i.y+this.y)*t.pixelDensity,l=[this.text,s,h];this.fillStyle&&(t.context.fillStyle=this.fillStyle,t.context.fillText(...l)),this.strokeStyle&&(t.context.strokeStyle=this.strokeStyle,t.context.lineWidth=e,t.context.strokeText(...l))}}}class I{asset;x;y;width;height;constructor(t){typeof t.asset=="string"&&(t.asset=J(t.asset)),this.asset=t.asset,this.x=t.x||0,this.y=t.y||0,this.width=t.width||this.asset.image.width||0,this.height=t.height||this.asset.image.height||0}render(t,i){const e=(i.x+this.x)*t.pixelDensity,s=(i.y+this.y)*t.pixelDensity,h=this.width*t.pixelDensity,l=this.height*t.pixelDensity;t.context.drawImage(this.asset.image,e,s,h,l)}}class it{constructor(t,i,e,s){this.x=t,this.y=i,this.size=e,this.posX=this.size*this.x,this.posY=this.size*this.y,this.container=new _({width:this.size,height:this.size,x:this.posX,y:this.posY,onClick:s}),this.updateContainer()}container;posX;posY;mined=!1;covered=!0;flagged=!1;nearbyMines=0;get isMined(){return this.mined}get isCovered(){return this.covered}get isFlagged(){return this.flagged}get hasNearbyMines(){return this.nearbyMines}populate(t,i){this.mined=t,this.nearbyMines=i}uncover(){this.container.interactive=!1,this.covered=!1,this.flagged=!1,this.updateContainer()}toggleFlag(){this.flagged=!this.flagged,this.updateContainer()}updateContainer(){if(this.container.clear(),this.container.fillStyle=this.covered?"#6b8e23":"#f9edcc",this.container.strokeStyle="#ebdfbe",this.covered){this.flagged&&this.container.add(new I({asset:v.Flag,width:this.size*.65,height:this.size*.65,x:(this.size-this.size*.65)/2,y:(this.size-this.size*.65)/2}));return}this.mined?this.container.add(new I({asset:v.Boom,width:this.size,height:this.size})):this.nearbyMines>0&&this.container.add(new tt({text:`${this.nearbyMines}`,fillStyle:"black",x:this.size/2,y:this.size/2}))}}const et={pixelDensity:2,width:320,height:320},st=15;class nt{canvas;context;pixelDensity;width;height;children=[];renderTimeout=0;constructor(t){typeof t.canvas=="string"&&(t.canvas=document.querySelector(t.canvas));const{canvas:i,pixelDensity:e,width:s,height:h}={...et,...t};this.canvas=i,this.pixelDensity=e,this.width=s,this.height=h,this.context=this.canvas.getContext("2d"),this.canvas.width=this.width*this.pixelDensity,this.canvas.height=this.height*this.pixelDensity,this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`,this.canvas.addEventListener("contextmenu",l=>{l.preventDefault()}),this.canvas.addEventListener("pointerdown",l=>{l.preventDefault();const{x:r,y:u}=this.canvas.getBoundingClientRect(),g=l.clientX-r,d=l.clientY-u,b=[...this.children].reverse();for(let x=0;x<b.length;x++){const y=b[x];if(y.active&&typeof y.onClick=="function"&&y.isHitBy(g,d)){y.interactive&&y.onClick({event:l,container:y,engine:this});break}}})}add(...t){this.children.push(...t)}clear(){this.children=[]}render(){this.renderTimeout&&window.clearTimeout(this.renderTimeout),this.renderTimeout=window.setTimeout(()=>{for(let t=0;t<this.children.length;t++)this.children[t].render(this)},st)}}class ht{constructor(t,i,e,s,h,l,r,u,g,d){this.view=t,this.tileSize=i,this.tilesX=e,this.tilesY=s,this.minesCount=h,this.firstClick=l,this.setFlagsCount=r,this.unpause=u,this.finish=g,this.close=d,this.initBoard()}paintEngine;width;height;minesIndex;tiles;pauseOverlay;flagsCount;triggeredMinedTile;initBoard(){this.width=this.tilesX*this.tileSize,this.height=this.tilesY*this.tileSize,this.paintEngine?this.paintEngine.clear():this.paintEngine=new nt({canvas:this.view,width:this.width,height:this.height,pixelDensity:2}),this.flagsCount=0,this.tiles=[],this.minesIndex=[],this.triggeredMinedTile=null,this.pauseOverlay=null,this.initTiles()}showPauseOverlay(){this.pauseOverlay||(this.pauseOverlay=new _({fillStyle:"#6b8e23",width:this.width,height:this.height,onClick:()=>this.unpause()}),this.paintEngine.add(this.pauseOverlay)),this.pauseOverlay.active=!0,this.paintEngine.render()}hidePauseOverlay(){this.pauseOverlay&&(this.pauseOverlay.active=!1,this.paintEngine.render())}initTiles(){for(let t=0;t<this.tilesY;t++)for(let i=0;i<this.tilesX;i++){const e=new it(i,t,this.tileSize,({event:s})=>this.onTileClick(s,i,t));this.tiles.push(e),this.paintEngine.add(e.container)}this.paintEngine.render()}initMines(t,i){let e=[];for(let h=0;h<this.tilesX*this.tilesY;h++)e.push(h<this.minesCount);let s=0;do e=K(e),s++;while(s<1e4&&(e[this.getTileIndex(t,i)]||this.getNearbyTileCoordinates(t,i).some(([h,l])=>e[this.getTileIndex(h,l)])));this.minesIndex=e}populateTiles(){this.tiles.forEach((t,i)=>t.populate(this.minesIndex[i],this.getNearbyTileCoordinates(t.x,t.y).filter(([e,s])=>this.minesIndex[this.getTileIndex(e,s)]).length))}onTileClick(t,i,e){this.minesIndex.length===0&&(this.firstClick(),this.initMines(i,e),this.populateTiles()),t.altKey||t.ctrlKey||t.metaKey||t.shiftKey||t.button>1?this.toggleFlag(i,e):this.uncoverTile(i,e)}getTileIndex(t,i){return i*this.tilesX+t}getNearbyTileCoordinates(t,i){return[[t-1,i-1],[t+0,i-1],[t+1,i-1],[t-1,i+0],[t+1,i+0],[t-1,i+1],[t+0,i+1],[t+1,i+1]].filter(([s,h])=>s>=0&&s<this.tilesX&&h>=0&&h<this.tilesY)}uncoverTile(t,i){const e=this.tiles[this.getTileIndex(t,i)];!e.isCovered||e.isFlagged||(e.uncover(),e.isMined?(this.triggeredMinedTile=e,this.tiles.forEach(s=>{s.isMined&&s.uncover()})):e.hasNearbyMines===0&&this.getNearbyTileCoordinates(t,i).forEach(([s,h])=>this.uncoverTile(s,h)),this.updateBoardState())}toggleFlag(t,i){const e=this.tiles[this.getTileIndex(t,i)];e.isCovered&&(e.toggleFlag(),this.flagsCount=this.tiles.reduce((s,h)=>h.isFlagged?++s:s,0),this.setFlagsCount(this.flagsCount),this.updateBoardState())}isBoardSolved(){return this.tiles.every(t=>t.isMined&&(t.isFlagged||t.isCovered)||!t.isMined&&!t.isFlagged&&!t.isCovered)}updateBoardState(){const t=!!this.triggeredMinedTile,i=!t&&this.isBoardSolved();if(t||i){const e=i?"rgba(0, 255, 0, 0.2)":"rgba(255, 0, 0, 0.2)",s=new _({fillStyle:e,width:this.width,height:this.height,onClick:()=>this.close()});this.paintEngine.add(s),this.finish(i?C.Won:C.Lost)}this.paintEngine.render()}}class at extends p{viewRef=N();unsubscribeSubject=new z;board;tileSize;tilesX;tilesY;minesCount;constructor(){super(),c.actions$.pipe(T(this.unsubscribeSubject)).subscribe(({name:t,state:i})=>{t===o.Restart?this.board.initBoard():t===o.Pause&&m.isPaused(i)?this.board.showPauseOverlay():t===o.Unpause&&m.isRunning(i)&&this.board.hidePauseOverlay(),m.player(i)||D(k.Home)})}componentDidMount(){this.board=new ht(this.viewRef.current,this.tileSize,this.tilesX,this.tilesY,this.minesCount,()=>c.dispatch(o.FirstClick),t=>c.dispatch(o.SetFlagsCount,{flagsCount:t}),()=>c.dispatch(o.Unpause),t=>c.dispatch(o.Finish,{finalStatus:t}),()=>D(k.Home))}componentWillUnmount(){this.unsubscribeSubject.next()}render(){const t=w(S);if(!this.board){const{tileSize:i,tilesX:e,tilesY:s,minesCount:h}=t;this.tileSize=i,this.tilesX=e,this.tilesY=s,this.minesCount=h}return a("div",{class:"c-game-gfx"},a("canvas",{class:"c-game-gfx__canvas",ref:this.viewRef,onContextMenu:this.onRightClick}))}onRightClick=t=>{t.preventDefault()}}class lt extends p{render(){const{finalStatus:t}=w(S),i=t===null?f.Magawa:t===C.Won?f.Party:f.Dead;return a("button",{class:"c-restart",title:"Restart Game",onClick:this.onClick},a("img",{class:"e-icon",src:`icons/${i}.png`}))}onClick=t=>{t.preventDefault(),c.dispatch(o.Restart)}}class ot extends p{timeout;componentWillUnmount(){this.stopTimeout()}render(){const t=w(S),i=m.isPaused(t);m.isFinished(t)||i?this.stopTimeout():this.startTimeout();const s=this.getDuration(t.startedAt,t.pausedAt),h=i?"Continue":"Pause",l=i?f.Zzz:f.Stopwatch;return a("button",{class:"c-timer",title:h,onClick:this.onClick},a("div",{class:"c-timer__icon"},a("img",{class:"e-icon",src:`icons/${l}.png`})),a("div",{class:"c-timer__label"},s))}onClick=t=>{t.preventDefault(),c.dispatch(o.TogglePause)};getDuration(t,i){const s=t?M(i===null?new Date:i,t):0;return B(s,!1)}startTimeout(){this.stopTimeout(),this.timeout=window.setTimeout(()=>{this.forceUpdate()},1e3)}stopTimeout(){this.timeout&&window.clearTimeout(this.timeout)}}class gt extends p{unsubscribeSubject=new z;highscoreSaved=!1;constructor(){super(),c.dispatch(o.Start),E(window,"blur").pipe(T(this.unsubscribeSubject)).subscribe(()=>c.dispatch(o.Pause)),E(document,"keydown").pipe(T(this.unsubscribeSubject),F(t=>t.code==="KeyP"||t.code==="Escape")).subscribe(()=>c.dispatch(o.TogglePause)),c.actions$.pipe(T(this.unsubscribeSubject),F(({name:t})=>t===o.Start)).subscribe(()=>{this.highscoreSaved=!1,this.setState({})})}componentWillUnmount(){this.unsubscribeSubject.next(),c.dispatch(o.Close)}render(t,{highscores:i,highscore:e}){const s=w(S);if(m.isClosed(s))return a("div",null);const h=m.isWon(s),{difficulty:l,startedAt:r,finishedAt:u,player:g}=s;h&&!this.highscoreSaved&&l!==P.Custom&&this.saveHighscore(r,u,g,l);const d=m.width(s);return a("div",{class:"c-game-view"},a("div",{class:"c-game-view__container",style:`width:${d}px; min-width:${d*.5}px`},a("div",{class:"c-game-view__bar"},a("div",{class:"c-game-view__bar-item"},a(ot,null)),a("div",{class:"c-game-view__bar-item"},a(lt,null)),a("div",{class:"c-game-view__bar-item"},a(L,null))),a(at,null)),h&&e&&i?a(R,null,a(j,{highscore:e,difficulty:l}),a(X,{rows:i.items,highlight:e?.id})):"",a("div",{className:"e-back-button"},a(W,{href:k.Home,class:"e-back-button__button e-button"},"← Back")))}async saveHighscore(t,i,e,s){this.highscoreSaved=!0;try{const h=await U(s,e,M(i,t)),l=await Y({difficulty:s,rank:h.rank});this.setState({highscore:h,highscores:l})}catch{}}}export{gt as GameView};
//# sourceMappingURL=game-view-y6TjEIAw.js.map
